<?page title="DOCSYS" ?>
<arya xmlns="aryaportal.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="aryaportal.org arya.xsd">
	<script>
$(document).ready(	function() {		<% Long merkezId = (Long) request.getAttribute("merkezId");		   String isyeriId = request.getParameter("isyeriId");		   String id = (merkezId == null) ? ( AgemUtils.isEmpty(isyeriId) ? "-1" : isyeriId ) : merkezId.toString();		   if (!"-1".equals(id)){		%>			Agem.ajax('genel/isyeri/select.do', 					{json:1, isyeriId:<%=id%>}, 					function(d){						Agem.byId("unvan").value = d.unvan;						Agem.byId("sgkKisaNo").value = d.sgkKisaNo;						setIsyeri(d);						if (d.secilebilir == '0') {							$('#seciliIsyeriOlarakAtaBtn').hide();							$('#tumunuCikarBtn').hide();						}					}, 					function(){});		<%}%>		Agem.addMaskEvents("sgkKisaNo");		AgemForm.autocomplete("sgkKisaNoParam", {varname: 'sgkKisaNoParam',url: 'genel/isyeri/autocomplete.do',pageSize: 5,callback: setIsyeriParam});		Agem.addMaskEvents("sgkKisaNoParam");		$("#orgutluParam").attr('checked',true);		divHeightAyarla();	}		);$(window).resize( function () {	divHeightAyarla();});var kategoriEsle = function() {	if (confirm("Alt işyerleri kategori bilgisi merkez kategori bilgisi ile güncellenecektir. Onaylıyor musunuz?")) {		Agem.ajax("genel/isyeriKategoriEsle/edit.do", {"merkezId": $("#isyeriId").val()}, 			function (r) {			if (r['@hata']) {				Agem.error(r['@message'],'x');			}		});	}};var divHeightAyarla = function () {	var h = $(window).height();	$("#alt-isyerleri").height(h-180);	$("#bulunan-isyerleri").height(h-180);};var setIsyeriParam = function(d) {	$("#sgkKisaNoParam").val(d.sgkKisaNo);	$("#unvanParam").val(d.unvan);}var LAST_ALT_PARAM = null;var setIsyeri = function(d, p) {	if (d && !d.isyeriId) {		LAST_ALT_PARAM = null;		return;	}	if (d)		Agem.setValue(d);	if (!p)		p = { merkezIdParam: d.isyeriId, page: 1, pageSize: 10};	LAST_ALT_PARAM = p;	Agem.byId('alt-isyerleri').innerHTML = "";	Agem.ajax("genel/isyeri/autocomplete.do?RxdE12=1", p, 		function (x) {			if (LAST_PARAM)				sorgula(LAST_PARAM.page, LAST_PARAM);			if (x.results && x.results.length < 1) {				Agem.message("Alt işyeri bulunamadı.");				Agem.byId('alt-page-links').innerHTML = "";				return;			}			Agem.message(x.fullListSize + " adet alt işyeri listelendi. ");			var table = Agem.addElement('table', 'alt-isyeri-table', {cellPadding:"3", cellSpacing:"3", className:"result-table"}, {width: '100%'}, Agem.byId('alt-isyerleri'));			var tbody = Agem.addElement('tbody', 'alt-isyeri-tbody', null, null, table);			for (var i=0; i<x.results.length; i+=1) {				var tr = Agem.addElement("tr", "tr-a-"+x.results[i].isyeriId, null, null, tbody);				var td = addIsyeriBilgileri(tr, x.results[i], 'a');				td['isyeri'] = x.results[i];				if (x.results[i].secilebilir == '1') {					Agem.addEventListener('click', td, function (e) {setAktifIsyeri(e, 'a');});					Agem.addEventListener('dblclick', td, 							function (e) {								if (!e) var e = window.event;								if (e && e.target) targ = e.target;								else if (e && e.srcElement) targ = e.srcElement;								if (targ) {									while (targ.tagName != 'TD') targ = targ.parentNode;							        isyeri = $(targ).attr("isyeri");									seciliIsyeriOlarakAta(isyeri.isyeriId, isyeri.unvan, isyeri.sgkKisaNo);								}							}						);				}			}			Agem.setupNumberLink(Agem.byId('alt-page-links'), ((x.fullListSize)/LAST_ALT_PARAM.pageSize), LAST_ALT_PARAM.page, '', 				function (sayfa) {					LAST_ALT_PARAM["page"] = sayfa;					setIsyeri(null, LAST_ALT_PARAM);				}			);		}	);};var LAST_PARAM = null;var sorgula = function(page, p) {	if (!page) page = 1;	if (!p) {		p = {};				if ($("#sgkKisaNoParamChecked").is(":checked")) {			p["sgkKisaNoParam"] = $("#sgkKisaNoParam").val();		}		if ($("#unvanParamChecked").is(":checked")) {			p["unvanParam"] = $("#unvanParam").val();		}		if ($("#orgutluParam").is(":checked")) {			p["orgutluParam"] = "1";		}	}	p["pageSize"] = 10;	p["page"] = page;	p["merkezOlmayanParam"] = 1; 	p["merkezIdIsNullParam"] = LAST_ALT_PARAM ? LAST_ALT_PARAM.merkezIdParam : -1; 	p["isyeriIdNotParam"] = LAST_ALT_PARAM ? LAST_ALT_PARAM.merkezIdParam : -1;	p["merkezGrupNotInParam"] = $('#isyeriId').val();		LAST_PARAM = p;	Agem.byId('bulunan-isyerleri').innerHTML = "";	Agem.ajax("genel/isyeri/autocomplete.do", p, function (x) {		if (x.results && x.results.length < 1) {			Agem.message("Sonuç bulunamadı.");			return;		}		var table = Agem.addElement('table', 'sorgu-isyeri-table', {cellPadding:"3", cellSpacing:"3", className:"result-table"}, {width: '100%'}, Agem.byId('bulunan-isyerleri'));		var tbody = Agem.addElement('tbody', 'sorgu-isyeri-tbody', null, null, table);		Agem.message(x.fullListSize + " adet işyeri bulundu. ");		if (x.results) {			for (var i=0; i<x.results.length; i+=1) {				var tr = Agem.addElement("tr", "tr-s-"+x.results[i].isyeriId, null, null, tbody);				var td = addIsyeriBilgileri(tr, x.results[i], 's');				td['isyeri'] = x.results[i];				Agem.addEventListener('click', td, function (e) {setAktifIsyeri(e, 's');});			}			Agem.setupNumberLink(Agem.byId('bulunan-page-links'), ((x.fullListSize)/LAST_PARAM.pageSize), LAST_PARAM.page, '', 				function (sayfa) {					sorgula(sayfa, LAST_PARAM);				}			);		}	});};function setAktifIsyeri(e, t) {	if (!e) var e = window.event;	if (e && e.target) targ = e.target;	else if (e && e.srcElement) targ = e.srcElement;	if (targ) {		while (targ.tagName != 'TD')			targ = targ.parentNode;		if (!e.ctrlKey) {			$(".active-td").removeClass("active-td");		}        $(targ).addClass("active-td");	}}function addIsyeriBilgileri (tr, x, t) {	return Agem.addElement("td", "td-"+t+"-"+x.isyeriId, null, null, tr, 			"<b>"+renklendir(x.unvan, Agem.byId('unvanParam').value, Agem.byId('unvanParamChecked').checked && t=='s')+"</b><br/>"+			renklendir(x.sgkKisaNo, Agem.byId('sgkKisaNoParam').value, Agem.byId('sgkKisaNoParamChecked').checked && t=='s')		);}function renklendir(val, sub, opr) {	if (opr) {		var d = sub.split('%');		var p = 0;		for (x in d) { 			var st = val.toLowerCase().indexOf( d[x].toLowerCase(), p );			if (st == -1)				return val;			if (st > -1) {				val = val.substring(0,st) + "<em>" + val.substring(st, st+d[x].length) + "</em>" + val.substring(st+d[x].length);				p += 4+5+st+d[x].length;			}		}	}	return val;}function seciliIsyeriOlarakAta(id, unvan, sgkKisaNo) {		AgemWM.addQueryString(Agem.json2Param( {isyeriIdParam: id, isyeriId: id}));	AgemWM.addSideInfo(		{			id:"isyeriInfo",			info: [				{					value: unvan, clazz: "pointer",					onclick: function () {						AgemWM.link('#genelIsyeriSelect', {url: 'genel/isyeri/select.do'});					}				},				{label: "SGK No", value: sgkKisaNo, clazz: "not-bold"}			],			type: 1		}	);}<% if (AsyaUtil.getInstance().merkezSube()) { %>function ekle(tumu) {	if (!LAST_ALT_PARAM || !LAST_ALT_PARAM.merkezIdParam || !LAST_PARAM) {		return;	}	var p = {isyeriId: LAST_ALT_PARAM.merkezIdParam};	if (tumu) {		var x = $("#bulunan-isyerleri td");		var d = [];		x.each(function (i, obj) {			var alt = $(obj).attr("isyeri");			d.push( alt.isyeriId );		});		if ($("#sgkKisaNoParamChecked").is(":checked")) {			p["sgkKisaNoParam"] = $("#sgkKisaNoParam").val();		}		if ($("#unvanParamChecked").is(":checked")) {			p["unvanParam"] = $("#unvanParam").val();		}		if ($("#orgutluParam").is(":checked")) {			p["orgutluParam"] = "1";		}		p["json"] = 1;		p["tip"] = 1;		Agem.ajax("genel/sihirbaz/add.do", p, function (r) {			setIsyeri({isyeriId: LAST_ALT_PARAM.merkezIdParam});		});	}	else {		var x = $("#bulunan-isyerleri .active-td");		var d = [];		x.each(function (i, obj) {			var alt = $(obj).attr("isyeri");			d.push( alt.isyeriId );		});		if (p.length == 0) {			Agem.error("Eklenecek işyerlerini seçiniz.");					}		p["alt"] = d.join(",");		p["json"] = 1;		Agem.ajax("genel/sihirbaz/add.do", p, function (r) {			setIsyeri({isyeriId: LAST_ALT_PARAM.merkezIdParam});		});	}}function sil(tumu) {	if (!LAST_ALT_PARAM || !LAST_ALT_PARAM.merkezIdParam) {		return;	}	var p = {isyeriId: LAST_ALT_PARAM.merkezIdParam};	if (tumu) {		p["json"] = 1;		p["tip"] = 1;		Agem.ajax("genel/sihirbaz/delete.do", p, function (r) {			setIsyeri({isyeriId: LAST_ALT_PARAM.merkezIdParam});		});	}	else {		var x = $("#alt-isyerleri .active-td");		var d = [];		x.each(function (i, obj) {			var alt = $(obj).attr("isyeri");			d.push( alt.isyeriId );		});		if (p.length == 0) {			Agem.error("Eklenecek işyerlerini seçiniz.");					}		p["alt"] = d.join(",");		p["json"] = 1;		Agem.ajax("genel/sihirbaz/delete.do", p, function (r) {			setIsyeri({isyeriId: LAST_ALT_PARAM.merkezIdParam});		});	}}function merkez() {	if (!$('#isyeriId').val()) {		Agem.error("Merkez işyeri bulunamadı.");		return;	}		var x = $("#alt-isyerleri .active-td");	var d = [];	x.each(function (i, obj) {		var alt = $(obj).attr("isyeri");		d.push( alt.isyeriId );	});	if (d.length != 1) {		Agem.error("Merkez olacak bir işyeri seçiniz.");		return;	}		var text = '';	var h = 130;	var w = 300;	var btn = [{id:'tamam', label:'Tamam', func : function() { merkezAta(d); return true; }},	               {id:'iptal', label:'İptal', func : function() { return true;}}];	text = "Seçili işyeri merkez işyeri olarak atanacaktır. Devam etmek istediğinize emin misiniz?";		AgemWM.alertBox({title:'Uyarı', height:h, width:w, message:text, buttons: btn});	}function merkezAta(d) {	if (!$('#isyeriId').val()) {		Agem.error("Merkez işyeri bulunamadı.");		return;	}		var x = $("#alt-isyerleri .active-td");	var d = [];	x.each(function (i, obj) {		var alt = $(obj).attr("isyeri");		d.push( alt.isyeriId );	});	if (d.length != 1) {		Agem.error("Merkez olacak işyerlerini seçiniz.");		return;	}	Agem.ajax("genel/sihirbaz/edit.do", {"json":1, "altIsyeriId" : d[0], "isyeriId":$('#isyeriId').val()}, 		function (r) {			if (!r['@hata']) {				Agem.ajax('genel/isyeri/select.do', 						{json:1, isyeriId:r.isyeriId}, 						function(d){							Agem.byId("unvan").value = d.unvan;							Agem.byId("sgkKisaNo").value = d.sgkKisaNo;							setIsyeri(d);							if (d.secilebilir == '0') {								$('#seciliIsyeriOlarakAtaBtn').hide();								$('#tumunuCikarBtn').hide();							}						}, 						function(){});			} else {				Agem.error(r['@message'],'x');			}					});}<% } else {  %>function ekle(tumu) {	alert('Bu işlemi yapmaya hakkınız yok...');}function sil(tumu) {	alert('Bu işlemi yapmaya hakkınız yok...');}function merkez() {	alert('Bu işlemi yapmaya hakkınız yok...');}function merkezAta(d) {	alert('Bu işlemi yapmaya hakkınız yok...');}<% } %>	</script>
</arya>
