<?page title="DOCSYS" ?>
<arya xmlns="aryaportal.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="aryaportal.org arya.xsd">
	<script>
var p_orgBirimIdParam = <bean:write name="p_orgBirimIdParam"/>;var _LAST_SELECTED_NODE;function ara() {	var val = $("#araMetin").val();	if (val) {		$("#organizasyon-container").jstree("search",val);	}}function ara_temizle() {	$("#araMetin").val("");	$("#organizasyon-container").jstree("clear_search");}function birimGoster(node,id,tur,url) {	url =  (url && url != 'null')  ?  (url.indexOf("?") > -1 ? url  + "&" : url + "?")  : "" ;		if (tur == '<%=Constant.C_ORG_BIRIM_TUR_KISI%>') {				AgemWM.window({ link: (url == "" ? "genel/orgKisi/select.do?orgKisiId="+id + "&orgBirimIdParam="+id : url + "orgKisiId="+id + "&orgBirimIdParam="+id), label: "Organizasyon Kişi",width: 800, height: 600});	} else {		AgemWM.window({ link:(url == "" ? "genel/orgBirim/select.do?orgBirimId="+id + "&orgBirimIdParam="+id : url + "orgBirimId="+id + "&orgBirimIdParam="+id), label: "Organizasyon Birim",width: 800, height: 600});	}}function birimEkle(node,id,tur,url) {	url =  (url && url != 'null')  ?  url  : 'genel/organizasyon/add.do' ;	var cont = '<table class="agem-form-table"><input type="hidden" name="tur" value="'+tur+'" /><tr class="agem-line0"><td width="30%" id="tanimLabel" class="agem-label agem-mandatory">';		if (tur == '<%=Constant.C_ORG_BIRIM_TUR_KISI%>') {			  		cont +='Ad Soyad';	} else {		cont += 'Ünvan';	}	cont += '</td><td width="70%" class="agem-input1"><input type="text" name="tanim" id="tanim"  value="" maxlength="255" mandatory="true" style="width: 150px" class="inp"></td></tr>';	if (tur == '<%=Constant.C_ORG_BIRIM_TUR_KISI%>') {			  		cont += '<tr class="agem-line0"><td width="30%" id="tcKimlikNoLabel" class="agem-label agem-mandatory">T.C. Kimlik No</td><td width="70%" class="agem-input1"><input type="text" name="tcKimlikNo" id="tcKimlikNo"  value="" maxlength="11" mandatory="true" style="width: 150px" class="inp"></td></tr>';		cont = cont + '<script>AgemDouble.attachEvents("tcKimlikNo", 0,false);<\/script>';	}	cont += '</table>';	var retFunc = function (obj) {		if (obj.tur == '<%=Constant.C_ORG_BIRIM_TUR_KISI%>') {			if (!obj.tanim || !obj.tcKimlikNo) {				alert('Lütfen kişinin ad, soyad ve T.C. kimlik no bilgisini giriniz...');				return false;			} else if (obj.tcKimlikNo.length != 11) {				alert('Girilen T.C. Kimlik Numarası 11 haneli olmalı. Lütfen Kontrol ediniz...');				return false;			}/* 			} else if (!AgemValidation.tckNoValidate(obj.tcKimlikNo)) {				alert('Girilen T.C. Kimlik Numarası geçersiz. Lütfen Kontrol ediniz...');				return false; 			} */		} else if (!obj.tanim){			alert('Lütfen ünvan bilgisini giriniz...');			return false;		}			    $.ajax({	        "url":url,	        data:{ orgBirimTurId: tur, ustOrgBirimId: id, tanim: obj.tanim, tcKimlikNo: obj.tcKimlikNo, json:"1"},	        async : false,	        timeout: 30000,	        dataType:"json",	        success:function(data){ 	            if (!data['@hata']) {	            		            	$("#organizasyon-container").jstree("create",node,"last",{ data : {title : data.tanim}, attr: {id:data.orgBirimId, birimTip:tur, sira:data.sira, tanim: data.tanim, sonlananAltBirimler : data.sonlananAltBirimler}, state : 'closed', children:[]}, 	            							function(newNode) { 	            									$('#organizasyon-container').jstree('toggle_node', newNode); 	            							} 	            	, true);	            		            } else {	                Agem.message(data['@message'],'x');	            }	         }, 	        error:function(xhr,err,e){ alert( "İşlemi gerçekleştirirken hata oluştu..." );}	      }); // $.ajax	      return true;	};	 	AgemWM.modal(			{				label: "Birim Ekleme", 				width: 450,				height: 300,				content: cont,				buttons: [				   {					   label: "Tamam",					   func: retFunc				   },				   {					   label: "İptal",					   func: function (obj) {return true;}				   }				]			});}function birimSil(node,id,tur,url) {<agem:access URL="genel/organizasyon/delete">			if (confirm($(node).attr("tanim")+" öğesini silmek istediğinizden emin misiniz ?")) {		url =  (url && url != 'null')  ?  url  : 'genel/organizasyon/delete.do' ;	    $.ajax({	        "url":url,	        data:{ orgBirimTurId: tur, orgBirimId: id, json:"1"},	        async : false,	        timeout: 30000,	        dataType:"json",	        success:function(data){ 	            if (!data['@hata']) {	                $("#organizasyon-container").jstree("remove",node);	            } else {	                Agem.message(data['@message'],'x');	            }	         },	        error:function(xhr,err,e){ alert( "İşlemi gerçekleştirirken hata oluştu..." );}	      }); // $.ajax	}</agem:access>}function customMenu(node) {    var items = {    };    <agem:access right="organizasyon.super"> <%	if (turler != null && !turler.isEmpty()) {		for (Iterator<Map.Entry<String,OrganizasyonTurForm>> i = turler.entrySet().iterator();i.hasNext();) {			Map.Entry<String, OrganizasyonTurForm> entry = i.next();			out.print("if ($(node).attr('birimTip') == '" +entry.getKey()+"') {");			if (!Constant.C_ORG_BIRIM_TUR_KISI.equals(entry.getKey())) {			    out.print("items.rename = {label: 'Yeniden Adlandır', action: function (node) { this.rename(node); }};");			    out.print("items.yenile = {label :'Yenile', action : function (node) { $('#organizasyon-container').jstree('refresh', node) }};");			}			out.print(" items.goster" + entry.getKey() + " = { label : \"Göster\", action : function(node) { birimGoster(node,$(node).attr('id'),'"+entry.getKey()+"','"+entry.getValue().getGosterUrl()+"');}};");			for(String str : entry.getValue().getEklenebilirList()) {				out.print(" items.ekle" + str + " = { label : \"" + turler.get(str).getTanim() +" Ekle\", action : function(node) { birimEkle(node,$(node).attr('id'),'"+str+"','"+turler.get(str).getEkleUrl()+"');}};");			}			if (new Integer(1).equals(entry.getValue().getSilinebilir())) {				out.print(" items.sil" + entry.getKey() + " = { label : \"Sil\", action : function(node) { birimSil(node,$(node).attr('id'),'"+entry.getKey()+"','"+entry.getValue().getSilUrl()+"');}};");			}			out.println("}");		}	} %> 	 var str = ($(node).attr('sonlananAltBirimler') && $(node).attr('sonlananAltBirimler') != "") ? $(node).attr("sonlananAltBirimler").split("#") : []; 	 for (var i=0 ; i < str.length; i++) { 		 eval( "delete items.ekle" + str[i]); 	 }	</agem:access>     return items;}var eskiGosterChanged = function() {		$.jstree._focused()._get_settings().json_data.ajax.url = "genel/organizasyon/list.do?pasifleriGosterParam=" + ($('#eskileriGoster').attr('checked') ? 'E' : 'H');	$("#organizasyon-container").jstree('refresh');};$(document).ready(function () {	$('#eskileriGoster').change(eskiGosterChanged);	var cont = $("#organizasyon-container");	divAyarla();	$(function () {		hTree = cont.jstree({ 			json_data : {				ajax : {					url : "genel/organizasyon/list.do",					data : function (n) {		                    return { ustOrgBirimIdParam : n.attr("id") };		                }		    	},				data : [ {		<%					 							OrganizasyonForm org = (OrganizasyonForm) request.getAttribute("kokBirim");							out.println("attr: { id: " + org.getOrgBirimId() + ", birimTip: \"" + org.getOrgBirimTurId() + "\", sira:" + org.getSira() + ", tanim:\"" + org.getTanim() + "\", sonlananAltBirimler : \""+ org.getSonlananAltBirimler()+"\"},");							out.println(" data:{ title:'" + org.getTanim() + "'");							out.println("}");							out.println(",children : [], state : 'closed'");		%>							    	}]			},			progressive_render: true,	        ui : { select_limit : 1 },	        types : {					type_attr : "birimTip",					valid_children : [ "<%=org.getOrgBirimTurId()%>" ],					types : {			            "default":{ 				            	select_node :function(node){				            						            		var nodeId= $(node).parent().attr("id");				            		var nodeType= $(node).parent().attr("birimTip");				            		if(!nodeId) {				            			nodeId = $(node).attr("id");				            			nodeType= $(node).attr("birimTip");				            		}				            		if (nodeId) {				            			if (_LAST_SELECTED_NODE != nodeId) {				            				var url = "";						            		if(nodeType == "kisi") {							            		url = "genel/orgKisi/static.do?orgKisiId="+nodeId;						            		} else {							            		url = "genel/orgBirim/static.do?orgBirimId="+nodeId;						            		}						            		$.ajax({						            	        "url":url,						            	        data:{ },						            	        async : false,						            	        timeout: 30000,						            	        dataType:"html",						            	        success:function(data){ 						            	                $("#displayContainer").html(data);						            	                divAyarla();						            	         },						            	        error:function(xhr,err,e){ alert( "İşlemi gerçekleştirirken hata oluştu..." )}});						            		_LAST_SELECTED_NODE = nodeId;				            			} 				            		}				            		return true; 				            	} 		        		}<%						if (turler != null && !turler.isEmpty()) {							out.println(",");							for (Iterator<Map.Entry<String,OrganizasyonTurForm>> i = turler.entrySet().iterator();i.hasNext();) {								Map.Entry<String, OrganizasyonTurForm> entry = i.next();								OrganizasyonTurForm base = entry.getValue();								out.print("\"" + base.getBaseOrgBirimTurId() +"\" : { icon : { image :\""+base.getIconYeri()+"\" }, valid_children : [");								if (!base.getEklenebilirList().isEmpty()) {									out.print("\"" + StringUtils.join(base.getEklenebilirList(),"\",\"") +"\"");								}								out.print("] }");																if (i.hasNext()) {									out.println(",");								}							}						}%>					}							},			search : {				show_only_matches : true,				case_insensitive : true,				ajax : {					url : "genel/organizasyon/list.do",					data : function (searchStr) {							if (p_orgBirimIdParam > -1) {								return { orgBirimIdParam: p_orgBirimIdParam};							} 		                    return { tanimParam: searchStr};		                }				}			},						contextmenu : {items: customMenu, select_node:true},   	        plugins : [ "themes", "json_data" , "ui", "search", "types","crrm", "dnd","contextmenu"]		});	  });	cont.bind("before.jstree", function (e, data) {				var stop = false;		        if(data.func === "move_node" && data.args.length == 4) {		        	<agem:access URL="genel/organizasyon/edit">		        				            e.stopImmediatePropagation();			            $.ajax({			                url:"genel/organizasyon/edit.do",			                data:{ type: "moveNode", birimId: data.args[0].attr("id") , referansId: data.args[1].attr("id") , moveType: data.args[2] },			                async : false,			                timeout: 30000,			                dataType:"json",			                success:function(data){ 				                if (data && data[0]['@hata']) {					                Agem.message(data[0]['@message'],'x');					                stop = true;				                }				             },			                error:function(xhr,err,e){ alert( "İşlemi gerçekleştirirken hata oluştu..." ); stop = true;}			              }); // $.ajax			         </agem:access>		        	<agem:access not="true" URL="genel/organizasyon/edit">		        		Agem.error("Bu işlemi yapmaya izniniz yok...");			         	stop = true;			         </agem:access>			         		        } else if(data.func == "rename_node"){ 		        	<agem:access URL="genel/organizasyon/edit">		        				            e.stopImmediatePropagation();			            $.ajax({			                url:"genel/organizasyon/edit.do",			                data:{ type: "updateNodeLabel" , birimId : data.args[0].attr("id") , orgBirimTurId : data.args[0].attr("birimTip") , tanim : data.args[1] },			                async : false,			                timeout: 30000,			                dataType:"json",			                success:function(data){ 				                if (data && data[0]['@hata']) {					                Agem.message(data[0]['@message'],'x');					                stop = true;				                }				             },			                error:function(xhr,err,e){ alert( "İşlemi gerçekleştirirken hata oluştu..." ); stop = true;}			              }); // $.ajax			         </agem:access>			        <agem:access not="true" URL="genel/organizasyon/edit">		        		Agem.error("Bu işlemi yapmaya izniniz yok...");			         	stop = true;			         </agem:access>			              		        }                 if (stop) return false;		    });  	cont.bind("search.jstree", function (e, data) {		if (p_orgBirimIdParam > -1) {			var nesne = $("li[id='"+data.rslt.str+"'] a");			if (nesne.length > 0) {				nesne.click();				p_orgBirimIdParam = -1;			}		}	});	// ilk node'u ac	cont.bind("loaded.jstree", function (event, data) { 		if (p_orgBirimIdParam > -1) {			cont.jstree("search",p_orgBirimIdParam);				} else {			$('#organizasyon-container').jstree('toggle_node', 'ul > li:first');		}    });		$("#organizasyon-container li").live("dblclick", function (data) {		if ($(this).hasClass('jstree-closed')) {			$("#organizasyon-container").jstree("open_node", this); 			} else {			$("#organizasyon-container").jstree("close_node", this); 			}				return false;             });		});$(window).resize( function () {	divAyarla();});var divAyarla = function () {	var h = $(window).height();	var w = $(window).width();	$("#organizasyon-container").height(h-60);	$("#displayContainer").height(h-60);	$("#displayContainer").width(w-370);};var raporAl = function () {	Other.submitRaporForm(null, 'rapor/organizasyon/report.do?r='+Math.random());};var kisiAc = function(){	AgemWM.window(				{					label:"Personel",					link:"genel/orgKisi/search",					width: 800, 					height: 600								});}	</script>
</arya>
